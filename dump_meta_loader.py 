#!/usr/bin/env python3
# dump_meta_loader.py
import frida, sys, time, os
from pathlib import Path

OUT_DIR = Path.home() / "programing" / "meta_chunks"
OUT_DIR.mkdir(parents=True, exist_ok=True)

if len(sys.argv) != 2:
    print("Usage: python dump_meta_loader.py <pid>")
    sys.exit(1)

PID = int(sys.argv[1])

def on_message(message, data):
    if message.get("type") == "send":
        payload = message.get("payload", {})
        print("[*] message:", payload)
        t = payload.get("type")
        if t == "meta_chunk" and data:
            # 如果脚本多次发送 chunk，这里附加到单个文件（或按需要改名）
            out_path = OUT_DIR / "global-metadata.runtime.dat"
            mode = "ab"  # append，避免覆盖（第一次运行前可删除旧文件）
            with open(out_path, mode) as f:
                f.write(data)
            print(f"[+] wrote chunk -> {out_path} (size={payload.get('size')})")
        elif t == "meta_done":
            print("[*] meta_done (size reported):", payload.get("size"))
        else:
            # 其他 debug 消息
            pass
    elif message.get("type") == "error":
        print("[!] script error:", message)
    else:
        print("[*] other message:", message)

def main():
    try:
        device = frida.get_usb_device(timeout=5)
    except Exception as e:
        print("[!] get_usb_device failed:", e)
        sys.exit(1)

    print("[*] attaching to pid", PID)
    try:
        session = device.attach(PID)
    except Exception as e:
        print("[!] attach failed:", e)
        sys.exit(1)

    js_path = Path(__file__).parent / "dump_metadata.js"
    if not js_path.exists():
        print("[!] missing JS file:", js_path)
        sys.exit(1)

    src = js_path.read_text()

    # create_script with runtime='v8' — VERY IMPORTANT
    print("[*] creating script with runtime='v8' ...")
    script = session.create_script(src, runtime='v8')

    script.on('message', on_message)
    script.load()
    print("[*] script loaded. calling dumpmeta via exports_sync ...")

    try:
        # use exports_sync to call the RPC and wait for immediate return
        r = script.exports_sync.dumpmeta()
        print("[*] dumpmeta returned:", r)
    except Exception as e:
        print("[!] exception calling dumpmeta():", e)

    print("[*] waiting 10s for messages...")
    time.sleep(10)
    print("[*] finished. chunks in", OUT_DIR)

if __name__ == '__main__':
    main()